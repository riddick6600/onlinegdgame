<!doctype html>
<html>
  <head>
    <title>GD Game</title>
    <style>

      body {
        margin: 0;
        overflow: hidden;
      }

      #wrapper {
        height: 100%;
        overflow: hidden;
      }

      #field {
        position: absolute;
        bottom: 0;
      }

      .row {
        margin: 0;
      }

      .player {
        position: absolute;
        width: 100px;
        height: 100px;
        border-radius: 50px;
      }

      .player:before {
        content: '';
        position:absolute;
        background: url('hat3.png') no-repeat;
        background-size: contain;
        width: 160px;
        height: 100px;
        margin-top: -50px;
        margin-left: -14px;
      }

      .player div {
        font-size: 20px;
        position: absolute;
        bottom: -20px;
        width: 100px;
        text-align: center;
        white-space: nowrap;
      }

      .square {
        display: inline-block;
        width: 100px;
        height: 100px;
        border: 1px solid black;
      }

      .black {
        background: black;
      }

    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  </head>
  <body>
    <div id="wrapper"><div id="field"></div></div>
    <script>
      $(function () {
        var socket = io();
        let players = {};
        socket.on('players', function(data){
          players = data
        });
        socket.on('win', function(id){
          $( "#field" ).stop( true, true )
          alert('Победитель: ' + players[id].name)
        });
        socket.on('field', function(field){
          $('#field').empty();
          field.reverse().forEach(xAxis => {
              const $templateRow = $('<div class="row"></div>');
            xAxis.forEach(yAxis => {
              const $templateSquare = $('<div class="square"></div>');
              if (yAxis !== 0) {
                if (yAxis === 1) {
                  $templateSquare.addClass('black');
                } else {
                  $templateSquare.append(`<div id="${yAxis}" class="player" style="background:${players[yAxis].color}"><div>${players[yAxis].name}</div></div>`)
                }
              }
              $templateRow.append($templateSquare);
            })
            $('#field').append($templateRow);
          })
        });
        const start = () => {
          socket.emit('start');

          let count = 0;
          const add = 250

          const anim = (num) => {
            num += add * count++
            $( "#field" ).stop( true, true ).animate({
            bottom: `-${num}px`
          }, 10000, 'linear',  function() {
            anim(num)
          });
          }

          setTimeout(() => {
            anim(add)
        }, 1000)
        }

        $(document).keyup((event) => {
          if (event.code === "Space") {
            start()
          }
        })
      });
    </script>
  </body>
</html>
