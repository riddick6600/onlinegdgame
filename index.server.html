<!doctype html>
<html>
  <head>
    <title>GD Game</title>
    <style>

      body {
        margin: 0;
        overflow: hidden;
      }

      #wrapper {
        height: 100%;
        overflow: hidden;
      }

      #field {
        position: absolute;
        bottom: 0;
      }

      .row {
        margin: 0;
        height: 100px;
      }

      #players {
        position: absolute;
        bottom: 0;
      }

      .player {
        position: absolute;
        width: 100px;
        height: 100px;
        border-radius: 50px;
      }

      .player:before {
        content: '';
        position:absolute;
        background: url('hat3.png') no-repeat;
        background-size: contain;
        width: 160px;
        height: 100px;
        margin-top: -50px;
        margin-left: -14px;
      }

      .player div {
        font-size: 20px;
        position: absolute;
        bottom: -20px;
        width: 100px;
        text-align: center;
        white-space: nowrap;
      }

      .square {
        display: inline-block;
        width: 100px;
        height: 100px;
        outline: 1px solid black;
      }

      .black {
        background: black;
      }

    </style>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  </head>
  <body>
    <div id="wrapper"><div id="field"></div><div id="players"></div></div>
    <script>
      $(function () {
        var socket = io();
        let players = {};

        socket.on('win', function(id){
          $( "#field" ).stop( true, true )
          alert('Победитель: ' + players[id].name)
        });


        socket.on('field', function(field){
          $('#field').empty();
          field.reverse().forEach(xAxis => {
              const $templateRow = $('<div class="row"></div>');
            xAxis.forEach(yAxis => {
              const $templateSquare = $('<div class="square"></div>');
              if (yAxis !== 0) {
                if (yAxis === 1) {
                  $templateSquare.addClass('black');
                }
              }
              $templateRow.append($templateSquare);
            })
            $('#field').append($templateRow);
          })
        });


        socket.on('players', function(data){
          players = data
          $('#players').empty();
          Object.keys(players).map(key => {
            const player = players[key];
            const position = player.position
            $('#players').append(`<div id="${key}" class="player" style="background:${player.color};bottom:${position[0] * 100}px;left:${position[1] * 100}px;"><div>${player.name}</div></div>`)
          })
        });

        const start = () => {

          let count = 0;
          const add = 250
          const TIME = 10000

          const anim = (num) => {
            num += add * count++
            $( "#field, #players" ).animate({
              bottom: `-${num}px`
            }, TIME, 'linear');
            setTimeout(() => {anim(num)}, TIME)
          }

          setTimeout(() => {
            $('#players').stop(true,true).css({height:$('#field').css('height')})
            anim(add)
        }, 0)
        }
        socket.on('start', start)

        $(document).keyup((event) => {
          if (event.code === "Space") {
            socket.emit('start');
          }
        })
        $(document).on('dblclick', function (e) {
          socket.emit('start');
        });
      });
    </script>
  </body>
</html>
